<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-2xl">
      <h1 class="text-2xl font-bold mb-4">Update User Profile</h1>

      <!-- Form for updating user details -->
      <form id="userForm" class="bg-white p-6 rounded shadow-md">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="email"
            >Email</label
          >
          <input
            type="email"
            id="email"
            name="email"
            class="mt-1 p-2 w-full border rounded"
            required
            value="cebef10858@leabro.com"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="role"
            >Role</label
          >
          <input
            type="text"
            id="role"
            name="role"
            class="mt-1 p-2 w-full border rounded"
            required
            value="athlete"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="name"
            >Name</label
          >
          <input
            type="text"
            id="name"
            name="name"
            class="mt-1 p-2 w-full border rounded"
            required
            value="John Doe"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="gender"
            >Gender</label
          >
          <select
            id="gender"
            name="gender"
            class="mt-1 p-2 w-full border rounded"
            required
          >
            <option value="">Select Gender</option>
            <option value="male" selected>Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="mb-4">
          <label
            class="block text-sm font-medium text-gray-700"
            for="date_of_birth"
            >Date of Birth</label
          >
          <input
            type="date"
            id="date_of_birth"
            name="date_of_birth"
            class="mt-1 p-2 w-full border rounded"
            required
            value="1990-01-01"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="weight"
            >Weight (kg)</label
          >
          <input
            type="number"
            id="weight"
            name="weight"
            step="0.01"
            class="mt-1 p-2 w-full border rounded"
            required
            value="70"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="height"
            >Height (cm)</label
          >
          <input
            type="number"
            id="height"
            name="height"
            step="0.01"
            class="mt-1 p-2 w-full border rounded"
            required
            value="175"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="about_me"
            >About Me</label
          >
          <textarea
            id="about_me"
            name="about_me"
            class="mt-1 p-2 w-full border rounded"
            required
          >
Passionate about sports</textarea
          >
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="intrests"
            >intrests</label
          >
          <input
            type="text"
            id="intrests"
            name="intrests"
            class="mt-1 p-2 w-full border rounded"
            required
            value="Running, cycling"
          />
        </div>
        <div class="mb-4">
          <label
            class="block text-sm font-medium text-gray-700"
            for="achievements"
            >Achievements</label
          >
          <textarea
            id="achievements"
            name="achievements"
            class="mt-1 p-2 w-full border rounded"
            required
          >
Marathon winner 2023</textarea
          >
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="work"
            >Work</label
          >
          <input
            type="text"
            id="work"
            name="work"
            class="mt-1 p-2 w-full border rounded"
            required
            value="Coach"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="location"
            >Location</label
          >
          <input
            type="text"
            id="location"
            name="location"
            class="mt-1 p-2 w-full border rounded"
            required
            value="New York"
          />
        </div>
        <div class="mb-4">
          <label
            class="block text-sm font-medium text-gray-700"
            for="primary_sport"
            >Primary Sport</label
          >
          <input
            type="text"
            id="primary_sport"
            name="primary_sport"
            class="mt-1 p-2 w-full border rounded"
            required
            value="Running"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700" for="file"
            >Profile Image (Optional)</label
          >
          <input
            type="file"
            id="file"
            name="file"
            accept="image/*"
            class="mt-1 p-2 w-full border rounded"
          />
        </div>
        <button
          type="submit"
          class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
        >
          Update Profile
        </button>
      </form>

      <!-- Response display -->
      <div id="response" class="mt-4 p-4 bg-gray-200 rounded hidden"></div>

      <!-- User details display -->
      <div id="userDetails" class="mt-4 p-4 bg-gray-200 rounded hidden"></div>
    </div>

    <script>
      const form = document.getElementById("userForm");
      const responseDiv = document.getElementById("response");
      const userDetailsDiv = document.getElementById("userDetails");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        responseDiv.classList.add("hidden");
        userDetailsDiv.classList.add("hidden");

        const formData = new FormData();
        const email = form.elements["email"].value;
        // Add all fields except email to FormData
        for (const [key, value] of new FormData(form)) {
          if (key !== "email") {
            formData.append(key, value);
          }
        }

        try {
          // Send update request
          const updateResponse = await fetch(
            `http://localhost:3000/api/user/${email}`,
            {
              method: "PUT",
              body: formData,
            }
          );

          const contentType = updateResponse.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const text = await updateResponse.text();
            console.error("Non-JSON response:", text);
            throw new Error(
              `Expected JSON, got ${
                contentType || "no content-type"
              }: ${text.slice(0, 100)}`
            );
          }

          const updateResult = await updateResponse.json();
          responseDiv.classList.remove("hidden");
          responseDiv.innerHTML = `<pre class="text-sm">${JSON.stringify(
            updateResult,
            null,
            2
          )}</pre>`;

          if (updateResult.success) {
            // Fetch updated user details to verify
            const fetchResponse = await fetch(
              `http://localhost:3000/api/user/${email}`
            );
            if (
              !fetchResponse.headers
                .get("content-type")
                ?.includes("application/json")
            ) {
              const text = await fetchResponse.text();
              console.error("Non-JSON response from GET:", text);
              throw new Error(
                `Expected JSON, got ${
                  fetchResponse.headers.get("content-type") || "no content-type"
                }: ${text.slice(0, 100)}`
              );
            }

            const fetchResult = await fetchResponse.json();
            if (fetchResult.success) {
              userDetailsDiv.classList.remove("hidden");
              const user = fetchResult.data.user;
              userDetailsDiv.innerHTML = `
              <h2 class="text-lg font-bold">Fetched User Details</h2>
              <pre class="text-sm">
ID: ${user.id}
Email: ${user.email}
Role: ${user.role}
Name: ${user.name}
Gender: ${user.gender}
Date of Birth: ${user.date_of_birth}
Weight: ${user.weight}
Height: ${user.height}
About Me: ${user.about_me}
intrests: ${user.intrests}
Achievements: ${user.achievements}
Work: ${user.work}
Location: ${user.location}
Primary Sport: ${user.primary_sport}
Image URL: ${user.image_url || "None"}
              </pre>
              ${
                user.image_url
                  ? `<img src="${user.image_url}" alt="Profile Image" class="mt-2 max-w-xs">`
                  : ""
              }
            `;
            } else {
              userDetailsDiv.classList.remove("hidden");
              userDetailsDiv.innerHTML = `<p class="text-red-500">Failed to fetch user: ${fetchResult.message}</p>`;
            }
          } else {
            responseDiv.classList.add("bg-red-100");
            responseDiv.innerHTML = `<p class="text-red-500">Update failed: ${updateResult.message}</p>`;
          }
        } catch (err) {
          responseDiv.classList.remove("hidden");
          responseDiv.classList.add("bg-red-100");
          responseDiv.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
        }
      });
    </script>
  </body>
</html>
